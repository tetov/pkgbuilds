# Maintainer: Anton Tetov Johansson <anton@tetov.xyz>

pkgname=indiekit
pkgver=0.1.4
pkgrel=1
_node_ver=14.15
pkgdesc='An IndieWeb publishing toolkit'
url='https://github.com/getindiekit/indiekit'
license=('MIT')
arch=('any')
depends=('nodejs')
makedepends=('nvm' 'npm')
source=("https://registry.npmjs.org/@$pkgname/$pkgname/-/$pkgname-$pkgver.tgz"
        "indiekit.sh")
        # 'indiekit.service'
        # 'indiekit.sysusers'
        # 'indiekit.tmpfiles'
        # 'indiekit.conf.d')
sha256sums=("f89575d9a4f96e79c7f7ade493d0dbd79e472d585c1b4ffb5a15997a4aa83baf"
        "1c2ec208e3b25f287aebde4b51c819fc064578c0dda37980156e530394e8ccad")

_ensure_local_nvm() {
    # let's be sure we are starting clean
    which nvm >/dev/null 2>&1 && nvm deactivate && nvm unload
    export NVM_DIR="${srcdir}/.nvm"

    # The init script returns 3 if version specified
    # in ./.nvrc is not (yet) installed in $NVM_DIR
    # but nvm itself still gets loaded ok
    source /usr/share/nvm/init-nvm.sh || [[ $? != 1 ]]
}

package() {
    _ensure_local_nvm

    nvm install $_node_ver
    nvm use $_node_ver

    npm install -g --prefix "${pkgdir}/usr" "${srcdir}/${pkgname}-${pkgver}.tgz"
    # Non-deterministic race in npm gives 777 permissions to random directories.
    # See https://github.com/npm/cli/issues/1103 for details.
    find "${pkgdir}/usr" -type d -exec chmod 755 {} +

    # npm gives ownership of ALL FILES to build user
    # https://bugs.archlinux.org/task/63396
    chown -R root:root "${pkgdir}"

    install -d "$pkgdir"/usr/share/licenses/$pkgname
    ln -s ../../../lib/node_modules/$pkgname/LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

# package() {
#     install -dm755 "${pkgdir}/usr/lib/flood"
#     install -D -m 644 "${srcdir}/${_pkgname}/package.json" "${pkgdir}/usr/lib/flood/"
#     install -D -m 644 "${srcdir}/${_pkgname}/package-lock.json" "${pkgdir}/usr/lib/flood/"

#     cd "${pkgdir}/usr/lib/flood/"
#     npm ci --production --cache "${srcdir}/npm-cache"

#     cp -r "${srcdir}/${_pkgname}/dist"/* "${pkgdir}/usr/lib/flood/"

#     install -D -m 755 "${srcdir}/flood.sh" "${pkgdir}/usr/bin/flood"

#     find "${pkgdir}" -name package.json -print0 | xargs -r -0 sed -i '/_where/d'
#     find "${pkgdir}/usr" -type d -exec chmod 755 {} +
#     chown -R root:root "${pkgdir}"

#     install -Dm644 "${srcdir}/flood.service" "${pkgdir}/usr/lib/systemd/system/flood.service"
#     install -Dm644 "${srcdir}/flood.sysusers" "${pkgdir}/usr/lib/sysusers.d/flood.conf"
#     install -Dm644 "${srcdir}/flood.tmpfiles" "${pkgdir}/usr/lib/tmpfiles.d/flood.conf"
#     install -Dm644 "${srcdir}/flood.conf.d" "$pkgdir/etc/conf.d/flood"

#     # This doesn't save us much but oh well
#     # Thanks Nicola (https://git.archlinux.org/svntogit/community.git/tree/trunk/PKGBUILD?h=packages/atom)
#     find "${pkgdir}"/usr/lib/flood/node_modules \
#         -name "*.a" -exec rm '{}' \; \
#         -or -name "*.bat" -exec rm '{}' \; \
#         -or -name "*.c" -exec rm '{}' \; \
#         -or -name "*.cpp" -exec rm '{}' \; \
#         -or -name "*.node" -exec chmod a-x '{}' \; \
#         -or -name "benchmark" -prune -exec rm -r '{}' \; \
#         -or -name "doc" -prune -exec rm -r '{}' \; \
#         -or -name "html" -prune -exec rm -r '{}' \; \
#         -or -name "man" -prune -exec rm -r '{}' \; \
#         -or -name "scripts" -prune -exec rm -r '{}' \; \
#         -or -path "*/less/gradle" -prune -exec rm -r '{}' \; \
#         -or -path "*/task-lists/src" -prune -exec rm -r '{}' \;
# }

